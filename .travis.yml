language: c
sudo: false

env:
  global:
    # RACKET_DIR is an argument to install-racket.sh
    - RACKET_DIR=~/racket
    - PATH="$RACKET_DIR/bin:$PATH"
  matrix:
    - RACKET_VERSION=6.9 DEPLOY=true

cache:
  directories:
    - ~/.racket

before_install:
- curl -L https://raw.githubusercontent.com/greghendershott/travis-racket/master/install-racket.sh | bash
# - if $COV; then raco pkg install --deps search-auto doc-coverage cover cover-codecov; fi # or cover-coveralls

jobs:
  include:
    - stage: phase1
      install:
      - mv ~/.racket ~/.racket-discard
      - mkdir ~/.racket
      - echo "$TRAVIS_BUILD_ID"
      - echo "$TRAVIS_BUILD_ID" > ~/.racket/travis_build_id
      - raco pkg install --deps search-auto -j 2 phc-adt # Start installing stuff, continue later to avoid timeout.
      script:
      - true
    - stage: phase2
      addons:
        apt:
          packages:
          - texlive-latex-base
          - texlive-fonts-extra
          - texlive-fonts-recommended
          - texlive-latex-extra
          - latex-xcolor
      install:
      - if test "$TRAVIS_BUILD_ID" != `cat ~/.racket/travis_build_id`; then travis_terminate 1; fi
      - rm -f ~/.racket/travis_build_id
      - echo "LaTeX extra packages:"
      - latex_home=$(kpsewhich -var-value=TEXMFHOME)
      - curl -L -o newunicodechar.ins http://mirrors.ctan.org/macros/latex/contrib/newunicodechar/newunicodechar.ins
      - curl -L -o newunicodechar.dtx http://mirrors.ctan.org/macros/latex/contrib/newunicodechar/newunicodechar.dtx
      - latex newunicodechar.ins
      - mkdir -p "$latex_home/tex/latex/newunicodechar"
      - mv newunicodechar.sty "$latex_home/tex/latex/newunicodechar"
      - curl -L -o mathpartir.dtx http://mirrors.ctan.org/macros/latex/contrib/mathpartir/mathpartir.dtx
      - curl -L -o mathpartir.ins http://mirrors.ctan.org/macros/latex/contrib/mathpartir/mathpartir.ins
      - latex mathpartir.ins
      - mkdir -p "$latex_home/tex/latex/mathpartir"
      - mv mathpartir.sty "$latex_home/tex/latex/mathpartir"
      - echo "Finished installing extra latex packages."
      - raco pkg install --deps search-auto -j 2
      - raco test -x -p "$(basename "$TRAVIS_BUILD_DIR")"
      - raco setup --check-pkg-deps --no-zo --no-launcher --no-install --no-post-install --no-docs --pkgs "$(basename "$TRAVIS_BUILD_DIR")";
      - rm -fr doc/
      - raco scribble --dest doc/phc-thesis --html --dest-name index --redirect-main https://docs.racket-lang.org/ --redirect https://docs.racket-lang.org/ scribblings/phc-thesis.scrbl
      - make > make.log
      - tail -n 500 make.log
      - find doc -name '*.html' -type f -print0 | xargs -0 ls -ld
      - find doc -name '*.html' -type f -print0 | xargs -0 sed -i -e 's|https://download\.racket-lang\.org/docs/6\.9/html/|https://docs.racket-lang.org/|g'
      - find doc -name '*.html' -type f -print0 | xargs -0 ls -ld
      - if test "x${DEPLOY:-}" = "xtrue"; then sh ./auto-push-gh-pages.sh; fi
      - mv ~/.racket ~/.racket-discard
      - mkdir ~/.racket # clear the cache
      script:
      - true

#after_success:
# - sh ./auto-push-master.sh
